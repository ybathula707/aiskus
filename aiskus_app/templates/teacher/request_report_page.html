<!DOCTYPE html>
<html>
<head>
    <title>AISKUS - Mind Reader Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(circle, #febc9a 0%, #fed7b3 30%, #fee8cc 60%, #fffaf7 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
        }

        .header-section {
            position: relative;
            margin-bottom: 40px;
        }

        .brain-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            user-select: none;
            color: transparent;
            -webkit-text-stroke: 2px black;
            text-stroke: 2px black;
        }

        .text-muted-pink-outlined {
            color: #d8789b !important;
            text-shadow: 
              -1px -1px 0 #000,
              1px -1px 0 #000,
              -1px 1px 0 #000,
              1px 1px 0 #000;
            font-weight: 900 !important;
        }
        
        .text-black-slick {
            color: #000 !important;
            font-weight: 500 !important;
        }

        .title {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 5px;
            user-select: none;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
        }

        .subtitle {
            font-size: 1.25rem;
            text-align: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            position: relative;
            user-select: none;
            margin-bottom: 30px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        /* Get Summaries Button */
        .mind-read-btn {
            background: linear-gradient(45deg, #ffb8d7, #febc9a);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 20px;
            font-weight: 700;
            border-radius: 60px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(254, 188, 154, 0.4);
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }

        .mind-read-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(254, 188, 154, 0.6);
            background: linear-gradient(45deg, #ffcce0, #ffcaa3);
        }

        .mind-read-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(254, 188, 154, 0.4);
        }

        .mind-read-btn.loading {
            transform: scale(0.98);
            opacity: 0.8;
        }

        .mind-read-btn .brain-emoji {
            font-size: 1.2em;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Reports Container */
        .reports-container {
            background: white;
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(255, 184, 215, 0.4);
            margin-bottom: 40px;
            min-height: 800px;
            display: flex;
            flex-direction: column;
        }

        .reports-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #febc9a;
        }

        .reports-title {
            font-size: 2rem;
            color: #d8789b;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 
              -0.5px -0.5px 0 #000,
              0.5px -0.5px 0 #000,
              -0.5px 0.5px 0 #000,
              0.5px 0.5px 0 #000;
        }

        .reports-subtitle {
            font-size: 1rem;
            color: #666;
            font-weight: 400;
        }

        .reports-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Individual Report Card */
        .report-card {
            border: 2px solid #fee8cc;
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            background: #fffaf7;
            transform: translateY(0);
            opacity: 1;
        }

        .report-card.new-report {
            transform: translateY(-20px);
            opacity: 0;
            animation: slideInReport 0.6s ease-out forwards;
        }

        @keyframes slideInReport {
            0% {
                transform: translateY(-20px);
                opacity: 0;
            }
            50% {
                transform: translateY(-5px);
                opacity: 0.8;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .report-card.current {
            border-color: #febc9a;
            box-shadow: 0 5px 20px rgba(254, 188, 154, 0.3);
        }

        .report-card.collapsed {
            border-color: #fee8cc;
        }

        .report-card.expanded {
            border-color: #febc9a;
            box-shadow: 0 5px 20px rgba(254, 188, 154, 0.25);
        }

        .report-card.collapsed:hover {
            border-color: #febc9a;
            box-shadow: 0 3px 15px rgba(254, 188, 154, 0.2);
            transform: translateY(-2px);
        }

        .report-header {
            padding: 20px 25px;
            background: linear-gradient(45deg, #febc9a, #fed7b3);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .report-card.current .report-header {
            background: linear-gradient(45deg, #ffb8d7, #febc9a);
            cursor: default;
        }

        .report-card.expanded .report-header {
            background: linear-gradient(45deg, #febc9a, #fed7b3);
        }

        .report-header-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .report-number {
            font-size: 1rem;
            opacity: 0.95;
            font-weight: 700;
        }

        .report-time {
            font-size: 0.85rem;
            opacity: 0.85;
            margin-top: 2px;
        }

        .expand-icon {
            font-size: 1.4rem;
            transition: transform 0.3s ease;
        }

        .report-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .report-card.current .expand-icon {
            display: none;
        }

        .report-content {
            padding: 30px;
            text-align: left;
            line-height: 1.6;
            font-size: 1.1rem;
            color: #333;
            display: block;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease;
        }

        .report-card.current .report-content {
            max-height: none;
            padding: 30px;
            animation: slideOpenContent 0.5s ease-out 0.3s both;
        }

        @keyframes slideOpenContent {
            0% {
                max-height: 0;
                opacity: 0;
            }
            100% {
                max-height: 2000px;
                opacity: 1;
            }
        }

        .report-card.expanded .report-content {
            max-height: 2000px;
            padding: 30px;
        }

        .report-card.collapsed .report-content {
            max-height: 0;
            padding: 0 30px;
        }

        .empty-state {
            text-align: center;
            color: #999;
            font-style: italic;
            font-size: 1.2rem;
            padding: 60px 20px;
        }

        .loading-state {
            text-align: center;
            color: #febc9a;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            gap: 10px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #febc9a;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .summary-content-section {
            margin-bottom: 25px;
        }

        .summary-content-section strong {
            color: #d8789b;
            display: block;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .student-headspace {
            background: linear-gradient(135deg, #fff3e0, #ffe8cc);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #febc9a;
            margin-bottom: 20px;
            font-style: italic;
            font-weight: 500;
            color: #5d4037;
        }

        .detailed-summary {
            background: #fafafa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            margin-bottom: 20px;
            white-space: pre-line;
            line-height: 1.7;
        }

        .topic-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .topic-tag {
            background: linear-gradient(45deg, #febc9a, #fed7b3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(254, 188, 154, 0.3);
            transition: transform 0.2s ease;
        }

        .topic-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(254, 188, 154, 0.4);
        }

        .report-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.85rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .stat-value {
            color: #d8789b;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .error-message {
            background: linear-gradient(45deg, #ef5350, #e57373);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            margin: 20px;
            box-shadow: 0 4px 15px rgba(239, 83, 80, 0.3);
        }

        .footer-note {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 50px;
        }

        .footer-note p {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.4;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .title {
                font-size: 3rem;
            }
            .subtitle {
                font-size: 1.1rem;
            }
            .brain-icon {
                font-size: 2rem;
            }
            .reports-container {
                padding: 25px;
                min-height: 600px;
            }
            .mind-read-btn {
                padding: 15px 35px;
                font-size: 18px;
            }
            .reports-title {
                font-size: 1.6rem;
            }
            .main-container {
                max-width: 100%;
            }
            .report-stats {
                flex-direction: column;
                gap: 15px;
            }
            .topic-tags {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .main-container {
                max-width: 100%;
                padding: 0 5px;
            }
            
            .header-section {
                margin-bottom: 30px;
            }
            
            .reports-container {
                padding: 20px;
                border-radius: 20px;
                min-height: 500px;
            }
            
            .title {
                font-size: 2.5rem;
                line-height: 1.1;
            }
            
            .subtitle {
                font-size: 1rem;
                margin-bottom: 20px;
                line-height: 1.3;
            }
            
            .brain-icon {
                font-size: 1.8rem;
                margin-bottom: 10px;
            }
            
            .mind-read-btn {
                font-size: 16px;
                padding: 12px 25px;
                border-radius: 40px;
                letter-spacing: 1px;
            }
            
            .reports-title {
                font-size: 1.4rem;
            }
            
            .report-content {
                font-size: 1rem;
                padding: 20px;
            }

            .report-card.current .report-content,
            .report-card.expanded .report-content {
                padding: 20px;
            }

            .report-header {
                padding: 15px 20px;
            }

            .student-headspace,
            .detailed-summary {
                padding: 15px;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header-section">
            <div class="brain-icon">🧠</div>
            <h1 class="title text-muted-pink-outlined">AISKUS</h1>
            <p class="subtitle text-black-slick">mind reading dashboard - insights from your questions</p>
        </div>
        
        <!-- Get Summaries Button -->
        <button id="get-summaries-btn" class="mind-read-btn">
            <span class="brain-emoji">🧠</span>
            Get Summaries
        </button>
        
        <!-- Reports Container -->
        <div class="reports-container">
            <div class="reports-header">
                <h2 class="reports-title">Class Mind Reading Reports</h2>
                <p class="reports-subtitle">AI-powered insights from student questions</p>
            </div>
            
            <div id="reports-list" class="reports-list">
                <div class="empty-state">
                    Click "Get Summaries" to retrieve insights from recent student questions 🔮
                </div>
            </div>
            
            <div id="error-message" class="error-message" style="display: none;">
                <!-- Error messages will be inserted here -->
            </div>
        </div>

        <div class="footer-note">
            <p>Understanding student thoughts through AI analysis of their questions 🌟</p>
        </div>
    </div>

    <script>
        let reportCounter = 0;
        let reports = [];

        document.getElementById("get-summaries-btn").addEventListener("click", function() {
            handleGetSummaries();
        });

        function handleGetSummaries() {
            const getSummariesBtn = document.getElementById("get-summaries-btn");
            const reportsList = document.getElementById("reports-list");
            const errorDiv = document.getElementById("error-message");
            
            // Get current epoch timestamp
            const epochTimestamp = Math.floor(Date.now() / 1000);
            
            // Update button state
            getSummariesBtn.classList.add('loading');
            getSummariesBtn.disabled = true;
            
            // Show loading state
            reportsList.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    Getting summaries... Retrieving student insights...
                </div>
            `;
            
            // Hide previous error messages
            errorDiv.style.display = 'none';
            
            // Make API call to backend with epoch timestamp
            fetch(`/get/summaries/latest?timestamp=${epochTimestamp}`, {
                method: "GET",
                headers: { 
                    "Content-Type": "application/json" 
                }
            })
            .then(response => response.json())
            .then(data => {
                // Reset button state
                getSummariesBtn.classList.remove('loading');
                getSummariesBtn.disabled = false;
                
                if (data.status === "success") {
                    addNewReport(data, new Date().toISOString());
                } else {
                    showError(data.message || "Failed to retrieve summaries.");
                }
            })
            .catch(error => {
                // Reset button state
                getSummariesBtn.classList.remove('loading');
                getSummariesBtn.disabled = false;
                
                // For development - show mock data if backend isn't ready
                console.log("Backend not ready, showing mock data with epoch timestamp:", epochTimestamp);
                showMockData(new Date().toISOString());
                
                // Uncomment below for actual error handling:
                // showError("Failed to connect to summaries service. Please try again.");
            });
        }

        function addNewReport(data, timestamp) {
            reportCounter++;
            const reportData = {
                id: reportCounter,
                data: data,
                timestamp: timestamp,
                generated_at: data.report?.generated_time ? new Date(data.report.generated_time * 1000).toISOString() : timestamp
            };
            
            // Add to beginning of reports array (most recent first)
            reports.unshift(reportData);
            
            renderReports(true); // Pass true to indicate this is a new report
            
            // Scroll to top of the page to show the new current report
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderReports(isNewReport = false) {
            const reportsList = document.getElementById("reports-list");
            
            if (reports.length === 0) {
                reportsList.innerHTML = `
                    <div class="empty-state">
                        Click "Get Summaries" to retrieve insights from recent student questions 🔮
                    </div>
                `;
                return;
            }
            
            let reportsHtml = '';
            
            reports.forEach((report, index) => {
                const isCurrentReport = index === 0;
                const reportTime = new Date(report.generated_at).toLocaleString();
                const newReportClass = (isNewReport && isCurrentReport) ? 'new-report' : '';
                
                reportsHtml += `
                    <div class="report-card ${isCurrentReport ? 'current' : 'collapsed'} ${newReportClass}" id="report-${report.id}" data-report-id="${report.id}">
                        <div class="report-header" ${!isCurrentReport ? 'onclick="toggleReport(' + report.id + ')"' : ''}>
                            <div class="report-header-info">
                                <div class="report-number">Report #${report.id}${isCurrentReport ? ' (Current)' : ''}</div>
                                <div class="report-time">${reportTime}</div>
                            </div>
                            ${!isCurrentReport ? '<div class="expand-icon">▼</div>' : ''}
                        </div>
                        <div class="report-content">
                            ${formatReportContent(report.data)}
                        </div>
                    </div>
                `;
            });
            
            reportsList.innerHTML = reportsHtml;
            
            // Remove animation class after animation completes
            if (isNewReport) {
                setTimeout(() => {
                    const newReportElement = document.querySelector('.new-report');
                    if (newReportElement) {
                        newReportElement.classList.remove('new-report');
                    }
                }, 600); // Match animation duration
            }
        }

        function formatReportContent(data) {
            const report = data.report;
            if (!report) {
                return '<div>No report data available.</div>';
            }

            let contentHtml = '';
            
            // Report Statistics
            contentHtml += `
                <div class="report-stats">
                    <div class="stat-item">
                        <div class="stat-label">Questions</div>
                        <div class="stat-value">${report.number_of_questions || 0}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Themes</div>
                        <div class="stat-value">${report.themes ? report.themes.length : 0}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Generated</div>
                        <div class="stat-value">${report.generated_time ? new Date(report.generated_time * 1000).toLocaleTimeString() : 'N/A'}</div>
                    </div>
                </div>
            `;
            
            // Student Headspace
            if (report.student_headspace) {
                contentHtml += `
                    <div class="summary-content-section">
                        <strong>Student Headspace:</strong>
                        <div class="student-headspace">
                            ${report.student_headspace}
                        </div>
                    </div>
                `;
            }
            
            // Detailed Summary
            if (report.summaary) { // Note: keeping the typo from your sample data
                contentHtml += `
                    <div class="summary-content-section">
                        <strong>Detailed Analysis:</strong>
                        <div class="detailed-summary">
                            ${report.summaary}
                        </div>
                    </div>
                `;
            }
            
            // Themes
            if (report.themes && report.themes.length > 0) {
                contentHtml += `
                    <div class="summary-content-section">
                        <strong>Key Themes Identified:</strong>
                        <div class="topic-tags">
                            ${report.themes.map(theme => `<span class="topic-tag">${theme}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            return contentHtml || '<div>No data available for this report.</div>';
        }

        function toggleReport(reportId) {
            const reportCard = document.getElementById(`report-${reportId}`);
            if (reportCard) {
                if (reportCard.classList.contains('collapsed')) {
                    reportCard.classList.remove('collapsed');
                    reportCard.classList.add('expanded');
                } else if (reportCard.classList.contains('expanded')) {
                    reportCard.classList.remove('expanded');
                    reportCard.classList.add('collapsed');
                }
            }
        }

        function showError(message) {
            const reportsList = document.getElementById("reports-list");
            const errorDiv = document.getElementById("error-message");
            
            if (reports.length === 0) {
                reportsList.innerHTML = '<div class="empty-state">Failed to retrieve summaries. Please try again.</div>';
            }
            
            errorDiv.innerHTML = message;
            errorDiv.style.display = 'block';
        }

        // Mock data using your sample response format
        function showMockData(timestamp) {
            const mockData = {
                "report": {
                    "generated_time": Math.floor(Date.now() / 1000),
                    "number_of_questions": 10,
                    "student_headspace": "Students are intrigued by the subject matter but struggle with the underlying concepts, indicating a need for more supportive and clear explanations.",
                    "summaary": "Overall, the student questions reveal significant knowledge gaps in understanding celestial mechanics, particularly concerning the moon's phases, seasonal variations, and the underlying reasons for natural phenomena. A common difficulty lies in grasping the conceptual understanding of explanations provided, indicating a need for more accessible and varied teaching approaches. Student sentiment is characterized by a mix of curiosity and frustration, with some expressing confusion and a desire for clearer communication. \n\nBased on these patterns, instructors should prioritize incorporating visual aids and interactive simulations to illustrate complex concepts. Employing multiple explanations, utilizing analogies and step-by-step breakdowns, and fostering peer discussion are crucial strategies.  It's important to build foundational understanding before progressing to more advanced topics.  Providing opportunities for students to ask clarifying questions and addressing misconceptions directly will enhance comprehension. \n\nThe overall student sentiment suggests a desire for foundational clarity and increased confidence in understanding basic astronomical concepts. While students are curious and engaged, they also express frustration when explanations are unclear or difficult to follow.  Adapting teaching styles to be more accessible and provide more scaffolding is essential to address this sentiment.",
                    "themes": [
                        "celestial motion",
                        "lunar phases", 
                        "seasonal variations",
                        "conceptual understanding",
                        "earth-moon relationship"
                    ]
                },
                "status": "success"
            };
            
            addNewReport(mockData, timestamp);
        }
    </script>
</body>
</html>
